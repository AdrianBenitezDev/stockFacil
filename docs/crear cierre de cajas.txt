Cerrar caja

//---------------------------------------------------------------

quiero que realicemos el flujo para la implementaciÃ³n del cierre de caja
ðŸŸ¢ CASO ONLINE
Paso 1 â€” Sincronizar ventas pendientes

Buscar en IndexedDB ventas con:

synced == false


Enviarlas a syncSales

Function las guarda y responde OK

Marcar synced = true en local

Paso 2 â€” Cerrar caja (solo backend calcula)

Frontend envÃ­a:

{
  tenantId,
  usuarioUid,
  turnoId
}


La Cloud Function:

Busca todas las ventas:

tenants/{tenantId}/ventas


con:

cajaId == null
usuarioUid == ...


Suma los totales reales en Firestore

Genera idCaja

Crea documento:

tenants/{tenantId}/cajas/{idCaja}

{
  idCaja,
  total,
  GanaciaRealCaja, //todas las ventas tienen calculado la ganacia Real (GanaciaRealVenta=(precio de venta - precioCompra)*cantidad) 
  usuarioUid,
  fechaApertura,
  fechaCierre,
  ventasIncluidas: [idVenta1, idVenta2],
  createdAt: serverTimestamp()
}


Actualiza todas esas ventas:

cajaId: idCaja


Devuelve:

{
  success: true,
  totalCaja: number,
  totalGananciaRealCaja:number,
  idCaja: string
}

ðŸ”´ CASO OFFLINE

PodÃ©s permitir:

âœ” Cierre de caja provisional
âœ” Crear objeto local:

{
  idCajaLocal,
  totalCalculadoLocal,
  ganaciaRealCalculadoLocal,
  synced: false
}


Pero NO lo consideres definitivo.

Cuando vuelva internet:

SincronizÃ¡s ventas

LlamÃ¡s a closeCashbox real

ComparÃ¡s totales

Si hay diferencia â†’ mostrar alerta

ðŸ’¡ Mejora importante

En vez de usar:

backups: "si"


UsÃ¡ booleanos reales:

synced: true
cajaCerrada: false

