Prompt completo para Codex (offline-first + multi-tenant + validaci√≥n)

Prompt:

Implementar l√≥gica de creaci√≥n y sincronizaci√≥n de productos para una aplicaci√≥n offline-first multi-tenant (KioscoStock).

üßæ Reglas generales

Solo usuarios autenticados de tipo "empleador" pueden crear productos.

La validaci√≥n de tipo debe hacerse tanto en el frontend (UX) como en la Cloud Function (seguridad).

Los productos pueden crearse aunque el dispositivo no tenga internet.

üì¶ Crear producto offline

Al crearse el producto, debe guardarse en IndexedDB con esta estructura de datos:

{
  codigo: string,        // c√≥digo universal, puede ser codigo de barras o un numero creado por si no tiene codigo de barras
  nombre: string,
  precioVenta: number,
  precioCompra: number,
   categoria: string, //seleccionada desde el frontend
  stock: number,
  tieneCodigoBarras: boolean,
  tenantId: string,     // uid del empleador
  synced: false,
  createdAt: number
}

(

    //generaremos el No codigo de barras asi:
    "INT-" + Date.now() // el frontend ya lo envia y coloca false al boelanno

)



El campo synced = false indica que todav√≠a no fue subido a Firebase.

El codigoBarras se usa como referencia para evitar duplicados y facilitar b√∫squedas.

üîÅ Sincronizaci√≥n de productos

La sincronizaci√≥n con Firebase debe ocurrir cuando:

Existan 30 productos con synced = false

O el usuario presione el bot√≥n "Sincronizar" (crea el boton)

O el dispositivo recupere conexi√≥n a internet (opcional)

‚òÅÔ∏è Cloud Function: syncProducts

La Cloud Function debe:

Validar el token Firebase.

Obtener el usuario autenticado.

Verificar que el usuario sea tipo ‚Äúempleador‚Äù.

Obtener tenantId (uid del empleador).

Guardar los productos en Firestore bajo:

tenants/{tenantId}/productos/{codigo}


‚Äì Cada documento de producto debe incluir:
nombre, codigo, precioVenta, precioCompra, categoria, synced, stock, tenantId, createdAt

Responder al frontend con los IDs sincronizados:

{
  success: true,
  syncedIds: [codigo1,codigo2,codigo3] //son los distintos codigo de barras
}

üîÑ Actualizaci√≥n local

El frontend debe:

Recibir la respuesta de la funci√≥n.

Buscar los productos en IndexedDB con esos IDs.

Cambiar su campo synced a true.

üîê Seguridad

Aunque la UI permita crear productos sin internet, la Cloud Function debe impedir que usuarios no autorizados (empleados o sin permisos) sincronicen productos.

La validaci√≥n real siempre debe ocurrir en la funci√≥n.

üìå Resumen

‚úì Crear productos offline con campos:


  codigo: string,        // c√≥digo universal, puede ser codigo de barras o un numero creado por si no tiene codigo de barras
  nombre: string,
  precioVenta: number,
  precioCompra: number,
   categoria: string, //seleccionada desde el frontend
  stock: number,
  tieneCodigoBarras: boolean,
  tenantId: string,     // uid del empleador
  synced: false,
  createdAt: number

  
precioVenta
‚úì Guardarlos localmente con synced:false
‚úì syncProducts solo si es empleador autenticado
‚úì Firestore multi-tenant:

tenants/{tenantId}/productos/{codigo}